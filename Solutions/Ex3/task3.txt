WITH HotelCategory AS (
    SELECT
        h.ID_hotel,
        h.name AS hotel_name,
        CASE
            WHEN AVG(r.price) < 175 THEN 'Дешевый'
            WHEN AVG(r.price) BETWEEN 175 AND 300 THEN 'Средний'
            ELSE 'Дорогой'
        END AS category
    FROM Hotel h
    JOIN Room r ON h.ID_hotel = r.ID_hotel
    GROUP BY h.ID_hotel
),
CustomerPreferences AS (
    SELECT
        c.ID_customer,
        c.name,
        MAX(CASE hc.category
            WHEN 'Дорогой' THEN 3
            WHEN 'Средний' THEN 2
            WHEN 'Дешевый' THEN 1
        END) AS category_priority
    FROM Customer c
    JOIN Booking b ON c.ID_customer = b.ID_customer
    JOIN Room r ON b.ID_room = r.ID_room
    JOIN HotelCategory hc ON r.ID_hotel = hc.ID_hotel
    GROUP BY c.ID_customer, c.name
)
SELECT
    cp.ID_customer,
    cp.name,
    CASE cp.category_priority
        WHEN 3 THEN 'Дорогой'
        WHEN 2 THEN 'Средний'
        WHEN 1 THEN 'Дешевый'
    END AS preferred_hotel_type,
    (
        SELECT STRING_AGG(DISTINCT h.name, ', ')
        FROM Booking b2
        JOIN Room r2 ON b2.ID_room = r2.ID_room
        JOIN Hotel h ON r2.ID_hotel = h.ID_hotel
        WHERE b2.ID_customer = cp.ID_customer
    ) AS visited_hotels
FROM CustomerPreferences cp
ORDER BY cp.category_priority;